# Руководство по функционалу натальных карт

## Обзор

Реализован полный функционал создания, просмотра и управления натальными картами в астрологической платформе.

## Что реализовано

### Backend (FastAPI)

#### 1. Модели данных
- **NatalChart** (`backend/app/models/natal_chart.py`):
  - Данные рождения (дата, время, место, координаты, часовой пояс)
  - Вычисленные астрологические данные (планеты, дома, аспекты)
  - Интерпретация карты
  - SVG визуализация (заготовка)
  - Флаг основной карты

#### 2. API Endpoints (`backend/app/api/v1/endpoints/charts.py`)
- `POST /api/v1/charts` - Создание натальной карты
- `GET /api/v1/charts` - Получение всех карт пользователя
- `GET /api/v1/charts/{chart_id}` - Получение конкретной карты
- `DELETE /api/v1/charts/{chart_id}` - Удаление карты
- `POST /api/v1/charts/{chart_id}/transits` - Расчет транзитов (Premium)

#### 3. Сервис астрологических расчетов (`backend/app/services/astro_calculator.py`)
- Интеграция с библиотекой `kerykeion` для точных расчетов
- Fallback на mock-данные, если kerykeion не установлен
- Расчет позиций планет в знаках и домах
- Определение аспектов между планетами
- Поддержка ретроградности планет

**Рассчитываемые планеты:**
- Солнце, Луна, Меркурий, Венера, Марс
- Юпитер, Сатурн, Уран, Нептун, Плутон
- Северный Узел (Раху)
- Асцендент (AC), Середина Неба (MC)

#### 4. Движок интерпретаций (`backend/app/services/interpretation_engine.py`)
- Шаблонные интерпретации для Free tier
- Заготовка для LLM-интерпретаций (OpenAI GPT-4)
- Интерпретации на русском языке
- Интерпретации Солнца и Луны в знаках

#### 5. Ограничения по тарифам
- **Free**: 1 натальная карта, шаблонные интерпретации
- **Basic**: Неограниченные карты, шаблонные интерпретации
- **Premium**: Неограниченные карты, AI интерпретации, транзиты

### Frontend (Next.js)

#### 1. UI компоненты
Созданы базовые компоненты с использованием Tailwind CSS:
- `Input` - поля ввода
- `Label` - метки для форм
- `Card` - карточки для контента
- `Button` - кнопки (уже существовал)

#### 2. Страницы

**a) `/dashboard/charts/new` - Создание натальной карты**
- Форма с полями:
  - Название карты
  - Дата рождения
  - Время рождения
  - Город и страна
  - Координаты (широта/долгота)
  - Часовой пояс
  - Флаг основной карты
- Валидация данных
- Отправка на backend API
- Переход к созданной карте после успешного создания

**b) `/dashboard/charts` - Список натальных карт**
- Отображение всех карт пользователя
- Карточки с информацией:
  - Название
  - Дата рождения
  - Место рождения
  - Дата создания
  - Метка основной карты
- Действия:
  - Открыть карту
  - Удалить карту
- Кнопка создания новой карты

**c) `/dashboard/charts/[id]` - Просмотр натальной карты**
- Полная информация о карте
- Вкладки:
  - **Планеты**: позиции всех планет в знаках и домах
  - **Дома**: куспиды 12 домов
  - **Аспекты**: межпланетные аспекты с орбами
  - **Интерпретация**: текстовая интерпретация карты
- Боковая панель с данными рождения
- Символы зодиака и планет

**d) `/dashboard` - Обновленный дашборд**
- Добавлена навигация к натальным картам
- Быстрый доступ из главного меню

## Как использовать

### 1. Запуск в режиме разработки

#### Backend:
```bash
cd backend
pip install -r requirements.txt
# Опционально для реальных расчетов:
pip install kerykeion
uvicorn app.main:app --reload
```

Backend будет доступен на `http://localhost:8000`
API документация: `http://localhost:8000/docs`

#### Frontend:
```bash
cd frontend
npm install
npm run dev
```

Frontend будет доступен на `http://localhost:3000`

### 2. Тестирование функционала

#### Шаг 1: Регистрация и вход
1. Откройте `http://localhost:3000`
2. Зарегистрируйте нового пользователя
3. Войдите в систему

#### Шаг 2: Создание натальной карты
1. На дашборде нажмите "Натальная карта"
2. Нажмите "+ Создать карту"
3. Заполните форму:
   - Название: "Моя карта"
   - Дата: выберите дату рождения
   - Время: введите время (например, 14:30)
   - Город: Москва
   - Страна: Россия
   - Широта: 55.7558
   - Долгота: 37.6173
   - Часовой пояс: Europe/Moscow
4. Нажмите "Создать натальную карту"

#### Шаг 3: Просмотр карты
1. После создания откроется страница карты
2. Переключайтесь между вкладками:
   - Планеты - смотрите позиции
   - Дома - проверьте куспиды
   - Аспекты - изучите взаимосвязи
   - Интерпретация - читайте описание

#### Шаг 4: Управление картами
1. Вернитесь к списку карт
2. Создайте еще одну карту (если не Free tier)
3. Попробуйте удалить карту

### 3. API Endpoints

#### Создание карты
```bash
curl -X POST http://localhost:8000/api/v1/charts \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тестовая карта",
    "birth_date": "1990-01-15",
    "birth_time": "14:30",
    "birth_city": "Москва",
    "birth_country": "Россия",
    "birth_latitude": 55.7558,
    "birth_longitude": 37.6173,
    "birth_timezone": "Europe/Moscow",
    "is_primary": false
  }'
```

#### Получение всех карт
```bash
curl -X GET http://localhost:8000/api/v1/charts \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### Получение конкретной карты
```bash
curl -X GET http://localhost:8000/api/v1/charts/{chart_id} \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Что еще нужно доработать

### 1. SVG визуализация карты
- Интеграция с kerykeion для генерации SVG
- Или создание собственной визуализации с D3.js/Canvas
- Отображение:
  - Зодиакального круга
  - Позиций планет
  - Линий аспектов
  - Домов

### 2. Геокодинг
- Интеграция с Google Maps Geocoding API или OpenStreetMap Nominatim
- Автоматическое определение координат по названию города
- Поиск городов с автодополнением

### 3. OpenAI интерпретации
- Интеграция OpenAI API для Premium пользователей
- Создание промптов для качественных интерпретаций
- Кеширование интерпретаций на 30 дней

### 4. Транзиты
- Полная реализация расчета транзитов
- Отображение текущих транзитов
- Прогнозы на будущее

### 5. Дополнительные функции
- Экспорт карты в PDF
- Сравнение карт (синастрия)
- Прогрессии и дирекции
- Солнечные возвращения

## Структура файлов

```
backend/
├── app/
│   ├── api/v1/endpoints/
│   │   └── charts.py          # API endpoints для карт
│   ├── models/
│   │   └── natal_chart.py     # Модель NatalChart
│   ├── schemas/
│   │   └── natal_chart.py     # Pydantic схемы
│   └── services/
│       ├── astro_calculator.py      # Расчеты карт
│       └── interpretation_engine.py # Интерпретации

frontend/
├── app/
│   └── dashboard/
│       ├── charts/
│       │   ├── page.tsx       # Список карт
│       │   ├── new/
│       │   │   └── page.tsx   # Создание карты
│       │   └── [id]/
│       │       └── page.tsx   # Просмотр карты
│       └── page.tsx           # Дашборд
└── components/ui/
    ├── button.tsx             # Кнопка
    ├── input.tsx              # Поле ввода
    ├── label.tsx              # Метка
    └── card.tsx               # Карточка
```

## Технические детали

### Библиотека kerykeion
- Использует Swiss Ephemeris для точных расчетов
- Лицензия: AGPL-3.0 (для коммерческого использования нужна лицензия)
- Точность: 0.001 секунды дуги
- Эфемериды: NASA JPL DE431

### Mock данные
- Если kerykeion не установлен, используются mock-данные
- Позволяет тестировать UI без установки зависимостей
- Помечены флагом `"mock": true`

## Безопасность

- Все endpoints требуют JWT токен
- Проверка владельца карты при доступе
- Ограничения по тарифам применяются автоматически
- Валидация всех входных данных

## Производительность

- Расчет натальной карты: < 3 секунды (требование)
- Интерпретации кешируются в БД
- Использование async/await для асинхронных операций
- PostgreSQL для надежного хранения

## Заключение

Базовый функционал натальных карт полностью реализован и готов к использованию. Пользователи могут:
- Создавать натальные карты
- Просматривать позиции планет
- Читать интерпретации
- Управлять своими картами

Следующие шаги - добавление SVG визуализации и интеграция AI интерпретаций для Premium пользователей.
